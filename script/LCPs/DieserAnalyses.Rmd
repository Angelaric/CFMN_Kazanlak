---
title: "Road network analises"
author: "Angel Bogdanov Grigorov"
date: "Created 17 Feb. 2023, updated `r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    highlight: tango
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

В този документ ще направя анализите за пътната система в различните епохи на моята дисертация. Анализите, които ще направя са описани в тези файлове: 
https://docs.google.com/document/d/1B7iC4Hf5kMpkWVMaTZDY_5YQOerrM3UqmHIq1WJqCoE/edit# 
Погледни глава Final Decision
и файл 
https://docs.google.com/document/d/17YWvdyXk8usTqtDWWInCIIrgsvizbndBPDT-lFfO5qs/edit

## Препаратионс
### Libraries

```{r libraries}

# All the library we need

library(tidyverse)
library(googledrive)
library(googlesheets4)
library(sf)
library(raster)
library(movecost)
library(sp)
library(rgdal)
library(leastcostpath)

```

```{r}
library(here)
```

```{r}
library(mapview)
```

### Нужни данни

```{r}

# Това е цялата територия нужна за анализите. В този растер Тунджа е кодирана с 0, което означава, че тя ще бъде разпознавана от модела като бариера и няма да го пропуска да преминава през нея. Към Тунджа са добавени бродовете, които съм регистрирал. Те ще служат за места, където моделът ще може да пресече реката.

Teritory <- raster("D:/Angel//Daisy_20220720/(_1_Tasks_DN/Shps/Sites/MainDirections/Directions.tif")

plot(Teritory)

```
## РЖЕ

Създаване на модел на пътната мрежа през РЖЕ и опит за нейното възстановяване. За целта избрах да използвам кумулативна фокусна мрежа за мобилност (Cumulative Focal Mobility Network или накратко кумулативен модел), чрез помощта на която е създаден модел с естествените коридорите на придвижване. Използвах функцията movenetw, разработена към пакета movecost към R за акумулиране на мрежа от пътища между множество изходни точки (Alberti 2022). Поради твърдението сред научните среди, че през РЖЕ пътните трасета са минавали по речните долини (цитирай), използвах функцията на Белавиа, която най-добре следва този модел (Herzog I. (2020). Spatial Analysis Based on Cost Functions. In Gillings M, Haciguzeller P, Lock G (eds), "Archaeological Spatial Analysis. A Methodological Guide.", Routledge: New York, 333-358). По този начин беше създадена мрежа от коридори, свързващи всичките селища, регистрирани през РЖЕ, помежду им (всеки със всеки). За да моделът да акумулира коридори, които да създадат пътищата, водещи през проходите извън котловината, бяха поставени контролни точки по краищата на генерираната територия, които да играят ролята на дестинации при трасирането на тези пътища.
Бяха генерирани два модела, всеки с по един контролен модел:
използващ само селищата датирани със сигурност в РЖЕ,
използващ само селищата датирани със сигурност в РЖЕ и контролните точки за акумулиране на трасета извън котловината, 
използващ и селищата с предполагаема датировка в РЖЕ.
използващ и селищата с предполагаема датировка в РЖЕ и контролните точки за акумулиране на трасета извън котловината.

### Само сигурно датирани обекти
#### С контролни точки по ръба

```{r}

# Това е шейпфайла с точките на селищните обекти от РЖЕ и контролните точки по ръба на територията. Взети са под внимание само обектите, които са със сигурни дати в тази епоха. 

EIA_1_Settlements_Regular_Points<-st_read("D:/Angel/Daisy_20220720/(_1_Tasks_DN/Shps/Sites/EIA_1_Settlements/EIA1_Settlements_Regulation_Points.shp")
EIA_1_Settlements_Regular_Points <- as_Spatial(EIA_1_Settlements_Regular_Points)

```

```{r}
# see what it looks like

plot(Teritory); plot(EIA_1_Settlements_Regular_Points,pch = 19, col="red", add = T)

```

Сега нека направим първият анализ с movenetw()

```{r}

# Сега пускам анализа за територията с Тунджа като бариера и добавени бродовете, за да моделът да може да прекосява Тунджа по тях. Слагам обектите и регулиращите точки по ръба и избирам Bellavia's cost function защото тя кара модела да избира долините на реките. 
 

movenetw(dtm=Teritory, origin = EIA_1_Settlements_Regular_Points, move = 8, funct = "b", lcp.dens = TRUE, export = TRUE)

# Нека видим какво ще се получи

```

Файловете са в D:/Angel/Daisy_20220720/(_1_Tasks_DN/ComulativeFocalMobilityNetwork/Results/EIA/EIA_Settlements_1_Regulation_Points

#### Сега същият анализ, но без регулиращите точки по ръба на растера.

```{r}

# Това е шейпфайла с точките на селищните обекти от РЖЕ без контролни точки по ръба. Взети са под внимание само обектите, които са със сигурни дати в тази епоха. 

EIA_1_Settlements <- st_read("D:/Angel/Daisy_20220720/(_1_Tasks_DN/Shps/Sites/EIA_1_Settlements/EIA_1_Settlements.shp")
EIA_1_Settlements <- as_Spatial(EIA_1_Settlements)

```

```{r}
# see what it looks like

plot(Teritory); plot(EIA_1_Settlements,pch = 19, col="red", add = T)

```

```{r}

# Сега пускам анализа за територията с Тунджа като бариера и добавени бродовете, за да моделът да може да прекосява Тунджа по тях. Слагам обектите, но без регулиращите точки по ръба и избирам Bellavia's cost function защото тя кара модела да избира долините на реките. 

movenetw(dtm=Teritory, origin = EIA_1_Settlements, move = 8, funct = "b", lcp.dens = TRUE, export = TRUE)

```

Файловете са в D:/Angel/Daisy_20220720/(_1_Tasks_DN/ComulativeFocalMobilityNetwork/Results/EIA/EIA_Settlements_1

### Включително несигурно датираните обекти
#### Включващ контролните точки

```{r}

# Това е шейпфайла с точките на селищните обекти от РЖЕ и контролните точки по ръба на територията. Взети са под внимание и обектите с въпросителна дата в РЖЕ. 

EIA_1_and_2_Settlements_Regular_Points<-st_read("D:/Angel/Daisy_20220720/(_1_Tasks_DN/Shps/Sites/EIA_1and2_Settlements/EIA_1and2_SettlementsRegulationPoints.shp")
EIA_1_and_2_Settlements_Regular_Points <- as_Spatial(EIA_1_and_2_Settlements_Regular_Points)

```

```{r}
# see what it looks like

plot(Teritory); plot(EIA_1_and_2_Settlements_Regular_Points,pch = 19, col="red", add = T)

```

```{r}

# Сега пускам анализа за територията с Тунджа като бариера и добавени бродовете, за да моделът да може да прекосява Тунджа по тях. Слагам обектите заедно с регулиращите точки по ръба и избирам Bellavia's cost function защото тя кара модела да избира долините на реките. 

movenetw(dtm=Teritory, origin = EIA_1_and_2_Settlements_Regular_Points, move = 8, funct = "b", lcp.dens = TRUE, export = TRUE)

```

Файловете са в D:/Angel/Daisy_20220720/(_1_Tasks_DN/ComulativeFocalMobilityNetwork/Results/EIA/EIA_Settlements_1_2_Regulation_Points

#### Сега същият анализ, но без регулиращите точки по ръба на растера.

```{r}

# Това е шейпфайла с точките на селищните обекти от РЖЕ без контролни точки по ръба. Взети са под внимание и обектите, които са с несигурна дати в тази епоха. 

EIA_1_and_2_Settlements <- st_read("D:/Angel/Daisy_20220720/(_1_Tasks_DN/Shps/Sites/EIA_1and2_Settlements/EIA_1and2_Settlements.shp")
EIA_1_and_2_Settlements <- as_Spatial(EIA_1_and_2_Settlements)

```

```{r}
# see what it looks like

plot(Teritory); plot(EIA_1_and_2_Settlements,pch = 19, col="red", add = T)

```

```{r}

# Сега пускам анализа за територията с Тунджа като бариера и добавени бродовете, за да моделът да може да прекосява Тунджа по тях. Слагам обектите, но без регулиращите точки по ръба и избирам Bellavia's cost function защото тя кара модела да избира долините на реките. 

movenetw(dtm=Teritory, origin = EIA_1_and_2_Settlements, move = 8, funct = "b", lcp.dens = TRUE, export = TRUE)

```

Файловете са в D:/Angel/Daisy_20220720/(_1_Tasks_DN/ComulativeFocalMobilityNetwork/Results/EIA/EIA_Settlements_1_2

Изглеждат добре! 

Като гледам тези резултати и коридорите, ми изглежда и може да стигна до някакво като предварително заключение, че подбалканския си съществува в РЖЕ. Той ясно се очертава, поне коридора. 

### Заключение

Изходните резултати са мрежа от връзки между точките с различна честота на тяхното използване от модела. Високочестотните връзки или коридори предполагат да бъдат основните пътища, свързващи обектите в една пътна система. По-малко честотните се интерпретирани като междуселски и пешеходни пътеки.
Разликата между модела със сигурно датирани обекти и този, включващ обекти с предполагаема датировка в РЖЕ не показват почти никакви разлики. Това се отдава на факта, че разликата между двата модела е само два допълнителни обекта в полза на втория. Също така няма почти никаква разлика в резултатите между модела без и модела с регулиращи точки. Единствената разлика е, че моделът с регулиращи точки е пресъздал пътищата, водещи извън котловината, но вътре, между обектите, те са същите, като при модела без регулиращи точки.
При така генерирания кумулативен модел се забелязва, че основният коридор е с ос изток запад, което е и естествения коридор на движение поради формата на котловината. При налагането на резултатите от кумулативния модел върху пътищата, възстановени по археологически, исторически и топографски данни (за по-кратко АИТ пътища) се забелязва основно няколко неща:
На места (при моделът с контролните точки) комулативният модел съвпада изключително точно с някои от тези АИТ пътища. 
Основният коридор получен при кумулативния модел върви по оста И – З и на места с различна точност съвпада с Подбалканският път, за който имаме сигурни данни, че е павиран през IV в. (цитирай), почти сигурно е, че е съществувал по-рано, а някои косвени данни подсказват, че е бил използван и през КЖЕ. Досега бях на мнението, че неговото датиране в по-ранни епохи от КЖЕ е рисковано, но полученият резултат от кумулативния модел показва, че това е естествен коридор и предлага неговото използване и в РЖЕ. 

Трябва да се отбележи, че АИТ пътищата са възстановени с независими от селищата данни. При тях не са използвани селищата като генератор за захранване на модела. При кумулативният модел са използвани само селищните обекти при генерирането им и застъпванията са базирани на автономни едни от други входни данни. 
В средата на картата се е образувал един възел от множество пресичащи се коридори, индикиращи важен кръстопът. На това място през IV в. пр. Хр. ще се появи Севтополис. Тук е един от бродовете на река Тунджа. Вероятно кръстопътното положение на този брод, в сърцето на котловината, през който преминават множество кръстосващи се пътища, е повлиял за решението градът на Севт да бъде издигнат тук. Предвид недостатъците на това място, като лоша видимост и лоша естествена защита, няма друго логично обяснение за това градът да е разположен тук. 

## Праистория

Тъй като започнах малко отзад напред и първо направих анализите с РЖЕ, затова сега описвам праисторията, но видяхме, че в РЖЕ модела не се променя кой знае колко, даже изобщо когато използвам само сигурно датирани обекти и когато добавя и несигурно датираните. Както отбелязах горе, това вероятно се дължи на факта, че разликата е от един-два обекта. В праисторията разликата между двете бройки е само един обект повече за вторите. Поради тази причина ще направя анализите за праисторията само със сигурно датираните в праисторията селища. След като отстраних обекти от типа “неопр.” и оставих само селища и селищни могили, обектите датирани със сигурност в праисторията останаха 24. Отново ще направя един модел само с обектите и втори с обектите и регулиращи точки за атрактори на коридори извън котловината. Ще използвам същите регулиращи точки, които използвах за РЖЕ, за да може моделът да бъде с еднакви критерии за двете епохи. Единствените променливи ще са само точките на селищата в котловината. 
Отново ще използвам функцията на Белавиа, поради същите критерий, заради които я използвах за РЖЕ.

### Само селищата като входящи данни

```{r}

# Това е шейпфайла с точките на селищните обекти от праисторията без контролни точки по ръба. Взети са под внимание само обектите, които са със сигурни дати в тази епоха. 

Prehist_1_Settlements <- st_read("D:/Angel/Daisy_20220720/(_1_Tasks_DN/Shps/Sites/Prehist_1_Settlements/Prehists_1_Settlements.shp")
Prehist_1_Settlements <- as_Spatial(Prehist_1_Settlements)

```

```{r}
# see what it looks like

plot(Teritory); plot(Prehist_1_Settlements,pch = 19, col="red", add = T)

```

```{r}

# Сега пускам анализа за територията с Тунджа като бариера и добавени бродовете, за да моделът да може да прекосява Тунджа по тях. Слагам обектите, но без регулиращите точки по ръба и избирам Bellavia's cost function защото тя кара модела да избира долините на реките. 

movenetw(dtm=Teritory, origin = Prehist_1_Settlements, move = 8, funct = "b", lcp.dens = TRUE, export = TRUE)

```

Файловете са в D:/Angel/Daisy_20220720/(_1_Tasks_DN/ComulativeFocalMobilityNetwork/Results/Pre/Pre_1_Settlements


### Селищата и регулиращите точки като входящи данни

```{r}

# Това е шейпфайла с точките на селищните обекти от праисторията и добавени контролни точки по ръба. Взети са под внимание само обектите, които са със сигурни дати в тази епоха. 

Prehist_1_SettlementsRegPoints <- st_read("D:/Angel/Daisy_20220720/(_1_Tasks_DN/Shps/Sites/Prehist_1_Settlements/Prehists_1_Settlements_RegPoints.shp")
Prehist_1_SettlementsRegPoints <- as_Spatial(Prehist_1_SettlementsRegPoints)

```

```{r}
# see what it looks like

plot(Teritory); plot(Prehist_1_SettlementsRegPoints,pch = 19, col="red", add = T)

```

```{r}

# Сега пускам анализа за територията с Тунджа като бариера и добавени бродовете, за да моделът да може да прекосява Тунджа по тях. Слагам обектите, но без регулиращите точки по ръба и избирам Bellavia's cost function защото тя кара модела да избира долините на реките. 

movenetw(dtm=Teritory, origin = Prehist_1_SettlementsRegPoints, move = 8, funct = "b", lcp.dens = TRUE, export = TRUE)

```

Файловете са в D:/Angel/Daisy_20220720/(_1_Tasks_DN/ComulativeFocalMobilityNetwork/Results/Pre/Pre_1_SettlementsRegPoints

### Заключение

## БЕ

Тук ще процедирам по същия начин по който процедирах за РЖЕ и праисторията. Разликата между бройката обекти, регистрирани със сигурност в БЕ и тези с добавени обектите с предполагаема дата в БЕ е само един обект – това е “крепостта” при Бузово кале, която и без това е съмнителна! След като селектирах само селищните обекти за анализа (изключих могилите и неопределените видове обекти), бройката на обектите влизащи в него е 13.
Отново ще използвам същите регулиращи точки, които използвах за РЖЕ и праисторията, за да може моделът да бъде с еднакви критерии за всичките епохи. Единствените променливи ще са само точките на селищата в котловината. 
Отново ще използвам функцията на Белавиа, поради същите критерий, заради които я използвах за РЖЕ и праисторията.


### Само селищата като входящи данни

```{r}

# Това е шейпфайла с точките на селищните обекти от БЕ без контролни точки по ръба. Взети са под внимание само обектите, които са със сигурни дати в тази епоха. 

BA_1_Settlements <- st_read("D:/Angel/Daisy_20220720/(_1_Tasks_DN/Shps/Sites/BA_1_Settlements/BA_1_Settlements.shp")
BA_1_Settlements <- as_Spatial(BA_1_Settlements)

```

```{r}
# see what it looks like

plot(Teritory); plot(BA_1_Settlements,pch = 19, col="red", add = T)

```

```{r}

# Сега пускам анализа за територията с Тунджа като бариера и добавени бродовете, за да моделът да може да прекосява Тунджа по тях. Слагам обектите, но без регулиращите точки по ръба и избирам Bellavia's cost function защото тя кара модела да избира долините на реките. 

movenetw(dtm=Teritory, origin = BA_1_Settlements, move = 8, funct = "b", lcp.dens = TRUE, export = TRUE)

```

Файловете са в D:/Angel/Daisy_20220720/(_1_Tasks_DN/ComulativeFocalMobilityNetwork/Results/BA/BA_1_Settlements


### Селищата и регулиращите точки като входящи данни

```{r}

# Това е шейпфайла с точките на селищните обекти от БА и добавени контролни точки по ръба. Взети са под внимание само обектите, които са със сигурни дати в тази епоха. 

BA_1_SettlementsRegPoints <- st_read("D:/Angel/Daisy_20220720/(_1_Tasks_DN/Shps/Sites/BA_1_Settlements/BA_1_Settlements_RegPoints.shp")
BA_1_SettlementsRegPoints <- as_Spatial(BA_1_SettlementsRegPoints)

```

```{r}
# see what it looks like

plot(Teritory); plot(BA_1_SettlementsRegPoints,pch = 19, col="red", add = T)

```

```{r}

# Сега пускам анализа за територията с Тунджа като бариера и добавени бродовете, за да моделът да може да прекосява Тунджа по тях. Слагам обектите, но без регулиращите точки по ръба и избирам Bellavia's cost function защото тя кара модела да избира долините на реките. 

movenetw(dtm=Teritory, origin = BA_1_SettlementsRegPoints, move = 8, funct = "b", lcp.dens = TRUE, export = TRUE)

```

Файловете са в D:/Angel/Daisy_20220720/(_1_Tasks_DN/ComulativeFocalMobilityNetwork/Results/BA/BA_1_SettlementsRegPoints

### Заключение

